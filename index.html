<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Общий Чат на Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Переопределение шрифта и базовых стилей Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        /* Установка максимальной высоты для мобильных устройств */
        .chat-container {
            height: 90vh;
            max-width: 700px;
            width: 100%;
        }

        /* Стилизация полосы прокрутки */
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* gray-300 */
            border-radius: 4px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #f7fafc; /* gray-50 */
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="chat-container bg-white shadow-2xl rounded-xl flex flex-col overflow-hidden">
        
        <!-- Header -->
        <div class="p-4 bg-indigo-600 text-white flex justify-between items-center shadow-md">
            <h1 class="text-xl font-bold">Общий Чат (Firebase)</h1>
            <div id="user-info" class="text-sm opacity-90">Загрузка...</div>
        </div>

        <!-- Nickname Setup -->
        <div class="nickname-setup p-6 text-center" id="nickname-section">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Выберите Ник</h2>
            <div id="loading-spinner" class="text-indigo-500 font-medium mb-4 hidden">Подключение к Firebase...</div>
            <input type="text" id="nickname-input" placeholder="Введите ваш ник (до 20 символов)" maxlength="20" class="w-full p-3 border-2 border-indigo-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
            <button onclick="setNickname()" id="nickname-button" class="w-full py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition duration-200 shadow-md disabled:opacity-50" disabled>
                Войти в Чат
            </button>
        </div>

        <!-- Chat Content -->
        <div id="chat-content" class="flex flex-col flex-grow hidden">
            <!-- Messages Area -->
            <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-3 bg-gray-50">
                <!-- Сообщения будут добавлены сюда -->
            </div>
    
            <!-- Input Form -->
            <div class="message-input p-4 border-t border-gray-200 bg-white">
                <div class="flex space-x-3">
                    <input type="text" id="message-input" placeholder="Введите сообщение..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button onclick="sendMessage()" id="send-button" class="px-6 py-3 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition duration-200 shadow-md">
                        Отправить
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports (Modular version) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";

        // setLogLevel('Debug'); // Раскомментировать для отладки

        // Глобальные переменные платформы
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let db, auth, userId = null;
        let isAuthReady = false;
        let userNickname = '';

        // DOM Elements
        const nicknameSection = document.getElementById('nickname-section');
        const chatContent = document.getElementById('chat-content');
        const nicknameInput = document.getElementById('nickname-input');
        const nicknameButton = document.getElementById('nickname-button');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const userInfoDisplay = document.getElementById('user-info');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Путь к публичной коллекции сообщений
        const MESSAGES_COLLECTION_PATH = `/artifacts/${appId}/public/data/chat_messages`;

        /**
         * 1. Инициализация Firebase и Аутентификация
         */
        try {
            loadingSpinner.classList.remove('hidden');
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Наблюдатель за состоянием аутентификации
            onAuthStateChanged(auth, async (user) => {
                loadingSpinner.classList.add('hidden');
                
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    userInfoDisplay.innerHTML = `Auth ID: <span class="font-mono text-xs">${userId}</span>`;
                    
                    // Активировать кнопку ника после успешной аутентификации
                    nicknameButton.disabled = false;
                    console.log("Успешная аутентификация. User ID:", userId);

                    // Если ник уже установлен (напр. после setNickname), начать прослушивание чата
                    if (userNickname) {
                        initChatListener();
                    }
                } else {
                    // Если токен доступен, используем его для входа
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        // Иначе анонимный вход
                        await signInAnonymously(auth);
                    }
                }
            });
        } catch (error) {
            console.error("Ошибка инициализации Firebase:", error);
            userInfoDisplay.textContent = 'Ошибка подключения.';
        }

        /**
         * 2. Устанавливает ник и переключает на интерфейс чата.
         */
        window.setNickname = function() {
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                userNickname = nickname;
                nicknameSection.classList.add('hidden');
                chatContent.classList.remove('hidden');
                
                if (isAuthReady) {
                    initChatListener();
                }

                // Приветственное сообщение (локальное)
                addLocalMessage('Система', `Вы вошли как: ${userNickname}. Начинайте общаться!`);
            } else {
                alert('Пожалуйста, введите ник.');
            }
        }

        /**
         * 3. Добавляет сообщение в Firestore.
         */
        window.sendMessage = async function() {
            const text = messageInput.value.trim();

            if (!text || !userNickname || !userId) {
                console.warn("Сообщение или ник отсутствует, или пользователь не авторизован.");
                return;
            }

            try {
                // Добавление документа в коллекцию
                await addDoc(collection(db, MESSAGES_COLLECTION_PATH), {
                    userId: userId,
                    nickname: userNickname,
                    text: text,
                    timestamp: serverTimestamp() // Время на сервере
                });

                messageInput.value = ''; // Очистка поля ввода
            } catch (e) {
                addLocalMessage('Ошибка', `Не удалось отправить сообщение: ${e.message}`);
                console.error("Ошибка при добавлении документа: ", e);
            }
        }

        /**
         * 4. Прослушивание Firestore в реальном времени.
         */
        function initChatListener() {
            // Создаем запрос: сортируем по времени и получаем все документы
            const messagesQuery = query(collection(db, MESSAGES_COLLECTION_PATH));
            
            // onSnapshot слушает изменения в реальном времени
            onSnapshot(messagesQuery, (snapshot) => {
                // Очищаем существующие сообщения перед обновлением
                chatMessages.innerHTML = ''; 
                
                // Преобразуем документы в массив, сортируем по времени
                const messages = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.timestamp) { // Проверяем наличие временной метки
                        messages.push({
                            ...data,
                            id: doc.id,
                            timeMs: data.timestamp.toMillis()
                        });
                    }
                });

                // Сортировка по времени (самое старое - сверху)
                messages.sort((a, b) => a.timeMs - b.timeMs);

                // Отображение сообщений
                messages.forEach(msg => {
                    addRemoteMessage(msg.nickname, msg.text, msg.timestamp, msg.userId === userId);
                });
            }, (error) => {
                console.error("Ошибка при прослушивании Firestore:", error);
                addLocalMessage('Ошибка', 'Не удалось загрузить сообщения в реальном времени.');
            });
        }
        
        /**
         * 5. Отображает сообщения из Firestore.
         */
        function addRemoteMessage(sender, text, timestamp, isOwn) {
            const messageElement = document.createElement('div');
            
            // Классы для общего стиля сообщения
            messageElement.classList.add('flex', 'max-w-xs', 'md:max-w-md', 'break-words', 'p-3', 'rounded-xl', 'shadow-sm', 'text-sm');

            // Классы для стиля "моего" сообщения (справа)
            if (isOwn) {
                messageElement.classList.add('bg-indigo-500', 'text-white', 'self-end', 'rounded-br-none', 'ml-auto');
            } else {
                // Классы для стиля "чужого" сообщения (слева)
                messageElement.classList.add('bg-white', 'text-gray-800', 'border', 'border-gray-200', 'self-start', 'rounded-tl-none');
            }

            const timeString = timestamp ? 
                new Date(timestamp.toMillis()).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : 
                '...'; // Если время еще не установлено (отправка)

            let contentHTML = `
                ${!isOwn ? `<span class="font-bold mr-2 ${isOwn ? 'text-white' : 'text-indigo-600'}">${sender}:</span>` : ''}
                <div class="flex flex-col">
                    <span>${text}</span>
                    <span class="text-xs ${isOwn ? 'text-indigo-200' : 'text-gray-400'} self-end mt-1">${timeString}</span>
                </div>
            `;
            
            messageElement.innerHTML = contentHTML;
            chatMessages.appendChild(messageElement);

            // Автоматическая прокрутка вниз
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * 6. Отображает локальные/системные сообщения.
         */
        function addLocalMessage(sender, text) {
            const messageElement = document.createElement('div');
            const now = new Date();
            const timeString = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            
            messageElement.classList.add('text-center', 'text-xs', 'text-gray-500', 'py-1', 'italic');
            messageElement.innerHTML = `[${timeString}] ${sender}: ${text}`;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Обработчики нажатия Enter
        nicknameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') setNickname();
        });
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

    </script>
</body>
</html>
